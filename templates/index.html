<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zach Agent â€” Legal & Compliance</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #F8FAFC;
      --bg2:     #F1F5F9;
      --surface: #FFFFFF;
      --border:  #E5E7EB;
      --border2: #D1D5DB;
      --accent:  #0EA5E9;
      --accent2: #0284C7;
      --green:   #10B981;
      --red:     #EF4444;
      --text:    #111827;
      --text2:   #4B5563;
      --text3:   #9CA3AF;
      --radius:  12px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 0 80px;
    }

    /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      width: 100%;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-box {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(14,165,233,.3);
      flex-shrink: 0;
    }

    .topbar-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -.015em;
    }

    .topbar-sub {
      font-size: .75rem;
      color: var(--text3);
      margin-top: 1px;
    }

    .btn-logout {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 16px;
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 8px;
      font-family: inherit;
      font-size: .8rem;
      font-weight: 600;
      color: var(--text2);
      cursor: pointer;
      text-decoration: none;
      transition: background .15s, color .15s;
    }

    .btn-logout:hover { background: var(--border); color: var(--text); }

    /* â”€â”€ Hero strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero-strip {
      width: 100%;
      background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 50%, #7C3AED 100%);
      padding: 28px 32px;
      text-align: center;
      color: white;
    }

    .hero-strip h2 {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: -.02em;
      margin-bottom: 4px;
    }

    .hero-strip p {
      font-size: .85rem;
      opacity: .85;
    }

    /* â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wrap {
      width: 100%;
      max-width: 860px;
      padding: 32px 20px 0;
    }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs {
      display: flex;
      gap: 2px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      padding: 9px 12px;
      border-radius: 7px;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 600;
      color: var(--text3);
      transition: color .2s, background .2s;
      white-space: nowrap;
      user-select: none;
    }

    .tab:hover:not(.active) { color: var(--text2); background: var(--bg2); }

    .tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      box-shadow: 0 2px 8px rgba(14,165,233,.3);
    }

    .tab-icon { font-size: 15px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: .8rem;
      color: var(--text3);
      margin-bottom: 20px;
    }

    /* â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    label {
      display: block;
      font-size: .73rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--text3);
      margin-bottom: 6px;
      margin-top: 16px;
    }

    label:first-child { margin-top: 0; }

    textarea, input[type="text"] {
      width: 100%;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: .88rem;
      line-height: 1.6;
      padding: 10px 13px;
      resize: vertical;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    textarea { min-height: 100px; }

    textarea:focus, input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(14,165,233,.12);
    }

    textarea::placeholder, input::placeholder { color: var(--text3); }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

    button {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: .85rem;
      font-weight: 600;
      transition: opacity .15s, transform .12s, box-shadow .15s;
    }

    button:hover:not(:disabled) { opacity: .88; transform: translateY(-1px); }
    button:active:not(:disabled) { transform: translateY(0); }
    button:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      box-shadow: 0 2px 8px rgba(14,165,233,.3);
    }

    .btn-secondary {
      background: var(--surface);
      border: 1.5px solid var(--border2);
      color: var(--text2);
    }

    .btn-success {
      background: rgba(16,185,129,.1);
      border: 1.5px solid rgba(16,185,129,.25);
      color: #059669;
    }

    /* â”€â”€ Drop zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .drop-zone {
      border: 2px dashed var(--border2);
      border-radius: 10px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      color: var(--text3);
      font-size: .88rem;
      background: var(--bg2);
    }

    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent);
      background: rgba(14,165,233,.05);
      color: var(--text2);
    }

    .drop-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    .drop-zone input { display: none; }

    .file-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      background: rgba(16,185,129,.1);
      border: 1px solid rgba(16,185,129,.25);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: .77rem;
      color: #059669;
    }

    /* â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-label {
      font-size: .72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .09em;
      color: var(--text3);
      margin-bottom: 12px;
    }

    .step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      background: var(--bg2);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      font-size: .82rem;
    }

    .step-icon { font-size: 15px; min-width: 22px; text-align: center; margin-top: 1px; }
    .step-tool { color: var(--accent2); font-weight: 700; margin-bottom: 2px; }
    .step-input { color: var(--text3); word-break: break-all; }
    .step-result { color: #059669; margin-top: 4px; }

    /* â”€â”€ Result block â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .result-block {
      background: var(--bg2);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      font-size: .88rem;
      line-height: 1.75;
      color: var(--text2);
      white-space: pre-wrap;
    }

    .result-success {
      background: rgba(16,185,129,.05);
      border-color: rgba(16,185,129,.2);
    }

    /* â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-wrap {
      margin-top: 12px;
      background: var(--bg2);
      border-radius: 999px;
      height: 5px;
      overflow: hidden;
      display: none;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width .3s;
      animation: shimmer 1.8s infinite;
    }

    @keyframes shimmer { 0%,100% { opacity:1; } 50% { opacity:.6; } }

    /* â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status {
      font-size: .8rem;
      color: var(--text3);
      margin-top: 10px;
      min-height: 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display: inline-block;
      width: 13px; height: 13px;
      border: 2px solid rgba(14,165,233,.25);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .65s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Download button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      padding: 10px 20px;
      background: rgba(16,185,129,.1);
      border: 1.5px solid rgba(16,185,129,.25);
      color: #059669;
      border-radius: 8px;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      text-decoration: none;
      transition: background .15s;
      font-family: inherit;
    }

    .download-btn:hover { background: rgba(16,185,129,.18); }

    /* â”€â”€ KB files list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kb-file-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 0;
      border-bottom: 1px solid var(--border);
      font-size: .85rem;
      color: var(--text2);
    }

    .kb-file-row:last-child { border-bottom: none; }

    .kb-delete-btn {
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.2);
      color: #DC2626;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: .75rem;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: background .15s;
    }

    .kb-delete-btn:hover { background: rgba(239,68,68,.15); }

    /* â”€â”€ Sources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .source-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 8px;
      background: var(--bg2);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      font-size: .83rem;
      color: var(--accent2);
      text-decoration: none;
      transition: background .15s, border-color .15s;
      word-break: break-all;
    }

    .source-link:hover {
      background: rgba(14,165,233,.07);
      border-color: var(--accent);
    }

    .source-icon { font-size: 14px; flex-shrink: 0; }

    /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .divider { height: 1px; background: var(--border); margin: 18px 0; }

    /* â”€â”€ Smart fill header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .smart-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <!-- Top Navigation Bar -->
  <nav class="topbar">
    <div class="topbar-left">
      <div class="logo-box">âš–ï¸</div>
      <div>
        <div class="topbar-title">Zach Agent</div>
        <div class="topbar-sub">Legal &amp; Compliance Portal</div>
      </div>
    </div>
    <a href="/logout" class="btn-logout">â†© Sign Out</a>
  </nav>

  <!-- Hero Strip -->
  <div class="hero-strip">
    <h2>Smart Agent for Browsing &amp; Questionnaires</h2>
    <p>Powered by Claude AI â€” Automate compliance work in seconds</p>
  </div>

  <div class="wrap">

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('browser')">
        <span class="tab-icon">ğŸŒ</span> Browser Agent
      </div>
      <div class="tab" onclick="switchTab('excel')">
        <span class="tab-icon">ğŸ“Š</span> Vendor Vetting
      </div>
      <div class="tab" onclick="switchTab('smart')">
        <span class="tab-icon">ğŸ“</span> Customer Questionnaire
      </div>
      <div class="tab" onclick="switchTab('kb')">
        <span class="tab-icon">ğŸ“š</span> Knowledge Base
      </div>
      <div class="tab" onclick="switchTab('grc')">
        <span class="tab-icon">ğŸ›¡ï¸</span> GRC-SOC2
      </div>
    </div>

    <!-- â•â•â• TAB 1: Browser Agent â•â•â• -->
    <div class="tab-content active" id="tab-browser">
      <div class="card">
        <div class="card-title">Browser Agent</div>
        <div class="card-sub">Describe a task and the agent will browse the web to find the answer.</div>
        <label>Task description</label>
        <textarea id="task" placeholder="e.g. Does Coralogix use customer data to train AI models?&#10;(Ctrl+Enter to run)"></textarea>
        <div class="btn-row">
          <button class="btn-primary" id="runBtn" onclick="runAgent()">â–¶ Run Agent</button>
          <button class="btn-secondary" onclick="closeBrowser()">âœ• Close Browser</button>
        </div>
        <div class="status" id="browserStatus"></div>
      </div>

      <div class="card" id="browserResultCard" style="display:none">
        <div class="section-label" style="margin-bottom:12px;">Final Result</div>
        <div class="result-block result-success" id="resultText"></div>
      </div>

      <div class="card" id="browserSourcesCard" style="display:none">
        <div class="section-label" style="margin-bottom:12px;">ğŸ“ Sources</div>
        <div id="sourcesList"></div>
      </div>

      <div class="card" id="browserStepsCard" style="display:none">
        <div class="section-label">Steps Executed</div>
        <div id="browserStepsList"></div>
      </div>
    </div>

    <!-- â•â•â• TAB 2: Vendor Vetting â•â•â• -->
    <div class="tab-content" id="tab-excel">
      <div class="card">
        <div class="card-title">Vendor Vetting</div>
        <div class="card-sub">Upload an Excel questionnaire and company details â€” the agent fills it automatically.</div>

        <label>Upload Excel file (questionnaire)</label>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()"
             ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <span class="drop-icon">ğŸ“‚</span>
          <div>Drag an Excel file here or <strong>click to browse</strong></div>
          <div class="file-name" id="fileName"></div>
          <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)" />
        </div>

        <label>Company details</label>
        <textarea id="companyInfo" style="min-height:150px" placeholder="Company name: ...
Address: ...
Registration number: ...
Country of incorporation: ...
Company size: ...
Contact name & title: ...
Email: ...
Phone: ...
Website: ...
ISO 27001: Yes/No
SOC 2: Yes/No
DPO: ...
CISO: ...
Insurance: ..."></textarea>

        <div class="btn-row">
          <button class="btn-primary" id="excelBtn" onclick="fillExcel()">ğŸ¤– Auto-Fill Questionnaire</button>
        </div>
        <div class="status" id="excelStatus"></div>
        <div class="progress-wrap" id="progressWrap">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>

      <div class="card" id="excelStepsCard" style="display:none">
        <div class="section-label">Cells Filled</div>
        <div id="excelStepsList"></div>
      </div>

      <div class="card" id="excelDownloadCard" style="display:none">
        <div class="section-label" style="margin-bottom:10px;">Questionnaire Ready</div>
        <div class="result-block result-success" id="excelResultText"></div>
        <a id="downloadLink" class="download-btn">â¬‡ Download Filled Excel</a>
      </div>
    </div>

    <!-- â•â•â• TAB 3: Customer Questionnaire â•â•â• -->
    <div class="tab-content" id="tab-smart">
      <div class="card">
        <div class="smart-header">
          <div>
            <div class="card-title">Smart Auto-Fill</div>
            <div class="card-sub" style="margin-bottom:0;">Upload questionnaire + company profile â†’ Agent fills it automatically</div>
          </div>
          <a href="/download-template" class="download-btn" style="margin-top:0; font-size:.78rem; padding:8px 14px;">
            â¬‡ Company Profile Template
          </a>
        </div>

        <label>1. Questionnaire file (Vendor Questionnaire)</label>
        <div class="drop-zone" id="dropZoneSmart" onclick="document.getElementById('smartQ').click()"
             ondragover="handleDragOver2(event)" ondragleave="handleDragLeave2(event)" ondrop="handleDrop2(event,'q')">
          <span class="drop-icon">ğŸ“‹</span>
          <div>Drag questionnaire here or <strong>click to browse</strong></div>
          <div class="file-name" id="smartQName"></div>
          <input type="file" id="smartQ" accept=".xlsx,.xls" onchange="handleSmartFile(event,'q')" />
        </div>

        <label>2. Company profile (company_data_template.xlsx)</label>
        <div class="drop-zone" id="dropZoneSmart2" onclick="document.getElementById('smartC').click()"
             ondragover="handleDragOver2(event)" ondragleave="handleDragLeave2(event)" ondrop="handleDrop2(event,'c')">
          <span class="drop-icon">ğŸ¢</span>
          <div>Drag company profile here or <strong>click to browse</strong></div>
          <div class="file-name" id="smartCName"></div>
          <input type="file" id="smartC" accept=".xlsx,.xls" onchange="handleSmartFile(event,'c')" />
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="smartBtn" onclick="runSmartFill()">ğŸ§  Auto-Fill</button>
        </div>
        <div class="status" id="smartStatus"></div>
        <div class="progress-wrap" id="smartProgressWrap">
          <div class="progress-bar" id="smartProgressBar"></div>
        </div>
      </div>

      <div class="card" id="smartDownloadCard" style="display:none">
        <div class="section-label" style="margin-bottom:10px;">Questionnaire Filled</div>
        <div class="result-block result-success" id="smartResultText"></div>
        <a id="smartDownloadLink" class="download-btn">â¬‡ Download Filled Questionnaire</a>
      </div>
    </div>

    <!-- â•â•â• TAB 4: Knowledge Base â•â•â• -->
    <div class="tab-content" id="tab-kb">
      <div class="card">
        <div class="card-title">Knowledge Base</div>
        <div class="card-sub">Upload your documents â€” the agent will use them to answer questions accurately.</div>

        <div class="drop-zone" id="dropZoneKB" onclick="document.getElementById('kbFileInput').click()"
             ondragover="handleDragOverKB(event)" ondragleave="handleDragLeaveKB(event)" ondrop="handleDropKB(event)">
          <span class="drop-icon">ğŸ“„</span>
          <div>Drag PDF, Excel, Word, or TXT files here or <strong>click to upload</strong></div>
          <div class="file-name" id="kbUploadStatus"></div>
          <input type="file" id="kbFileInput" accept=".pdf,.xlsx,.xls,.docx,.txt" multiple onchange="uploadKBFiles(event)" />
        </div>
      </div>

      <div class="card" id="kbFilesCard">
        <div class="section-label">Uploaded Documents</div>
        <div id="kbFilesList" style="font-size:.85rem; color:var(--text3);">Loading...</div>
      </div>

      <div class="card">
        <label>Ask a question</label>
        <textarea id="kbQuestion" style="min-height:90px" placeholder="e.g. Does Coralogix use customer data to train AI models?&#10;(Ctrl+Enter to ask)"></textarea>
        <div class="btn-row">
          <button class="btn-primary" id="kbAskBtn" onclick="askKB()">ğŸ” Ask</button>
        </div>
        <div class="status" id="kbStatus"></div>
        <div class="progress-wrap" id="kbProgressWrap">
          <div class="progress-bar" id="kbProgressBar"></div>
        </div>
      </div>

      <div class="card" id="kbAnswerCard" style="display:none">
        <div class="section-label" style="margin-bottom:12px;">Answer</div>
        <div class="result-block result-success" id="kbAnswerText"></div>
      </div>
    </div>

    <!-- â•â•â• TAB 5: GRC-SOC2 â•â•â• -->
    <div class="tab-content" id="tab-grc">

      <style>
        .grc-grid { display: flex; flex-direction: column; gap: 14px; }
        .grc-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .grc-card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; flex-wrap: wrap; margin-bottom: 10px; }
        .grc-left { display: flex; align-items: flex-start; gap: 12px; }
        .grc-id { font-size: .7rem; font-weight: 700; background: rgba(14,165,233,.1); border: 1px solid rgba(14,165,233,.25); color: var(--accent2); border-radius: 6px; padding: 3px 9px; white-space: nowrap; margin-top: 2px; }
        .grc-title { font-size: .95rem; font-weight: 700; color: var(--text); margin-bottom: 3px; }
        .grc-category { font-size: .75rem; color: var(--text3); }
        .grc-badge { font-size: .68rem; font-weight: 700; border-radius: 999px; padding: 3px 10px; white-space: nowrap; margin-top: 2px; }
        .badge-full { background: rgba(16,185,129,.1); border: 1px solid rgba(16,185,129,.25); color: #059669; }
        .badge-semi { background: rgba(245,158,11,.1); border: 1px solid rgba(245,158,11,.25); color: #d97706; }
        .badge-managed { background: rgba(99,102,241,.1); border: 1px solid rgba(99,102,241,.25); color: #6366f1; }
        .grc-desc { font-size: .82rem; color: var(--text2); line-height: 1.6; margin-bottom: 12px; }
        .grc-tools { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
        .grc-tool-chip { font-size: .72rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 999px; padding: 3px 10px; color: var(--text3); }
        .grc-footer { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
        .grc-status { font-size: .78rem; color: var(--text3); display: flex; align-items: center; gap: 6px; }
        .grc-result { margin-top: 14px; background: var(--bg2); border: 1.5px solid var(--border); border-radius: 8px; padding: 14px 16px; font-size: .83rem; line-height: 1.75; color: var(--text2); white-space: pre-wrap; display: none; }
        .grc-result.visible { display: block; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border2); display: inline-block; }
        .status-dot.running { background: #f59e0b; animation: pulse 1s infinite; }
        .status-dot.done { background: #10b981; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
      </style>

      <div class="card" style="margin-bottom:16px;">
        <div class="card-title">ğŸ›¡ï¸ SOC 2 Evidence Dashboard</div>
        <div class="card-sub">Run each control agent to automatically collect evidence. Results are structured for auditors.</div>
      </div>

      <div class="grc-grid">

        <!-- â”€â”€ CONTROL ENVIRONMENT â”€â”€ -->
        <div class="grc-card" id="grc-card-621">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_6_21</div>
              <div>
                <div class="grc-title">Policy Documents</div>
                <div class="grc-category">Control Environment</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Download the latest security & compliance policies from the relevant folder and verify they are up to date before placing in the evidence folder.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Google Drive</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-621"><span class="status-dot" id="dot-621"></span><span id="status-text-621">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('621','_6_21','Policy Documents','Download the latest security and compliance policies from the relevant Google Drive folder and verify they are updated. Confirm the policies are placed in the correct evidence folder. Report what was found and any gaps.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-621"></div>
        </div>

        <div class="grc-card" id="grc-card-10">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_10</div>
              <div>
                <div class="grc-title">Active Employee List</div>
                <div class="grc-category">Control Environment</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">From HiBob: filter only active employees and export all entities. Confirms access and training controls cover the full current workforce.</div>
          <div class="grc-tools"><span class="grc-tool-chip">HiBob</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-10"><span class="status-dot" id="dot-10"></span><span id="status-text-10">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('10','_10','Active Employee List','From HiBob, export the full list of active employees across all entities. Provide a count per entity/site, flag any anomalies, and confirm the population is complete for the audit period.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-10"></div>
        </div>

        <!-- â”€â”€ COMMUNICATION AND INFORMATION â”€â”€ -->
        <div class="grc-card" id="grc-card-1538">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">15_38</div>
              <div>
                <div class="grc-title">Customer Population</div>
                <div class="grc-category">Communication and Information</div>
              </div>
            </div>
            <span class="grc-badge badge-semi">â—‘ Maybe</span>
          </div>
          <div class="grc-desc">Extract new customer population for the audit period â€” potentially from Salesforce. Needs coordination with the relevant team to confirm the export method.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Salesforce</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-1538"><span class="status-dot" id="dot-1538"></span><span id="status-text-1538">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('1538','15_38','Customer Population','Extract the new customer population for the audit period. Check Salesforce for new accounts created in the audit window. Provide counts, dates, and any data completeness issues.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-1538"></div>
        </div>

        <!-- â”€â”€ SYSTEM OPERATIONS â”€â”€ -->
        <div class="grc-card" id="grc-card-19">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_19</div>
              <div>
                <div class="grc-title">CS Incidents Report</div>
                <div class="grc-category">System Operations</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Get a support incident report from Intercom (CS team). Was difficult to access in the last audit â€” coordinate with CS to ensure the export is available.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Intercom</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-19"><span class="status-dot" id="dot-19"></span><span id="status-text-19">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('19','_19','CS Incidents Report','Generate a customer support incident report from Intercom filtered to the audit period. List total tickets, resolved vs open, average resolution time, and any SLA breaches. Note any access limitations.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-19"></div>
        </div>

        <div class="grc-card" id="grc-card-27">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_27</div>
              <div>
                <div class="grc-title">Incident Population</div>
                <div class="grc-category">System Operations</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Generate the incident population report for the audit period (if incidents occurred). Lists all incidents with severity, date, and resolution status.</div>
          <div class="grc-tools"><span class="grc-tool-chip">PagerDuty</span><span class="grc-tool-chip">Jira</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-27"><span class="status-dot" id="dot-27"></span><span id="status-text-27">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('27','_27','Incident Population','Pull all incidents from the audit period. List each with: date, severity, systems affected, root cause, and resolution date. Confirm all P1/P2 incidents have a post-mortem linked.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-27"></div>
        </div>

        <div class="grc-card" id="grc-card-42">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_42</div>
              <div>
                <div class="grc-title">Endpoint Antivirus Report</div>
                <div class="grc-category">System Operations</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">From JAMF: report of all employee laptops showing that antivirus is installed and active on every managed device.</div>
          <div class="grc-tools"><span class="grc-tool-chip">JAMF</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-42"><span class="status-dot" id="dot-42"></span><span id="status-text-42">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('42','_42','Endpoint Antivirus Report','From JAMF, generate a report of all employee-managed laptops. Confirm antivirus is installed and active on each device. Count devices with/without antivirus and list any non-compliant endpoints.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-42"></div>
        </div>

        <!-- â”€â”€ RISK ASSESSMENT â”€â”€ -->
        <div class="grc-card" id="grc-card-20">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_20</div>
              <div>
                <div class="grc-title">Asset Inventory Export</div>
                <div class="grc-category">Risk Assessment</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Export asset inventory from the platform team. Lists all infrastructure assets (prod/stag/test) with owner, type, and classification.</div>
          <div class="grc-tools"><span class="grc-tool-chip">AWS</span><span class="grc-tool-chip">Platform</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-20"><span class="status-dot" id="dot-20"></span><span id="status-text-20">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('20','_20','Asset Inventory Export','Export the full asset inventory as of the audit date. List all infrastructure assets grouped by environment (prod/stag/test), with asset type, owner, and data classification. Flag any untagged or unclassified assets.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-20"></div>
        </div>

        <!-- â”€â”€ CONTROL ACTIVITIES â”€â”€ -->
        <div class="grc-card" id="grc-card-24">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_24</div>
              <div>
                <div class="grc-title">SAST Vulnerability Report</div>
                <div class="grc-category">Control Activities</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Export from Orca Security: all source-code vulnerabilities (SAST) identified during the audit period. Proves the internal scanning program is operating.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Orca Security</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-24"><span class="status-dot" id="dot-24"></span><span id="status-text-24">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('24','_24','SAST Vulnerability Report','From Orca Security, export all SAST vulnerabilities identified during the audit period. Report totals by severity (Critical/High/Medium/Low), remediation rate, and any unresolved critical items.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-24"></div>
        </div>

        <!-- â”€â”€ MONITORING ACTIVITIES â”€â”€ -->
        <div class="grc-card" id="grc-card-26">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_26</div>
              <div>
                <div class="grc-title">Monitoring Dashboard</div>
                <div class="grc-category">Monitoring Activities</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">CloudWatch dashboard showing every production asset/instance is monitored. Plus Coralogix CSPM security metrics and alert configuration evidence.</div>
          <div class="grc-tools"><span class="grc-tool-chip">CloudWatch</span><span class="grc-tool-chip">Coralogix CSPM</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-26"><span class="status-dot" id="dot-26"></span><span id="status-text-26">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('26','_26','Monitoring Dashboard','Collect evidence that all production infrastructure is monitored. Check CloudWatch: confirm all instances have monitoring enabled. Check Coralogix CSPM: list active security metrics, alert rules, and any triggered alerts during the audit period.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-26"></div>
        </div>

        <!-- â”€â”€ LOGICAL AND PHYSICAL ACCESS CONTROLS â”€â”€ -->
        <div class="grc-card" id="grc-card-2934">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_29 + _34</div>
              <div>
                <div class="grc-title">Okta Groups & Users</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">From Okta: full list of all groups with their corresponding user lists. Distinguish between owners and normal users for each group.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Okta</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-2934"><span class="status-dot" id="dot-2934"></span><span id="status-text-2934">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('2934','_29+_34','Okta Groups & Users','From Okta, list all groups with their complete user roster. For each group, separate owners from regular users. Flag any group with users who are no longer active employees.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-2934"></div>
        </div>

        <div class="grc-card" id="grc-card-3033">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_30 + _33</div>
              <div>
                <div class="grc-title">AWS Prod Access (IAM + SSO)</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Okta groups with access to prod AWS accounts, IAM permission sets, and SSO/SAML configuration. Shows who can reach production and with what privilege level.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Okta</span><span class="grc-tool-chip">AWS IAM</span><span class="grc-tool-chip">SSO/SAML</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-3033"><span class="status-dot" id="dot-3033"></span><span id="status-text-3033">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('3033','_30+_33','AWS Prod Access','List all Okta groups with access to production AWS accounts. For each group: user list, IAM permission set assigned, and SSO/SAML configuration. Flag any over-privileged access or users bypassing SSO.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-3033"></div>
        </div>

        <div class="grc-card" id="grc-card-3132">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_31 + _32</div>
              <div>
                <div class="grc-title">Password Policy & Admin List</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-semi">â—‘ Maybe</span>
          </div>
          <div class="grc-desc">Check Okta password policy settings and compile the list of Okta and AWS admins. Requires Okta admin permissions â€” needs IT team coordination.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Okta</span><span class="grc-tool-chip">AWS</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-3132"><span class="status-dot" id="dot-3132"></span><span id="status-text-3132">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('3132','_31+_32','Password Policy & Admins','Check the Okta password policy: minimum length, complexity, MFA enforcement, session timeout. Also list all Okta and AWS admin users. Flag any settings below industry standard or unexpected admins.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-3132"></div>
        </div>

        <div class="grc-card" id="grc-card-36">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_36</div>
              <div>
                <div class="grc-title">New Hire Population</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">From HiBob: filter employees hired during the audit period, across all sites. Evidence for onboarding access provisioning controls.</div>
          <div class="grc-tools"><span class="grc-tool-chip">HiBob</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-36"><span class="status-dot" id="dot-36"></span><span id="status-text-36">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('36','_36','New Hire Population','From HiBob, list all employees hired during the audit period across all sites. Include: name, start date, department, site/entity. Count per site and flag any missing onboarding data.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-36"></div>
        </div>

        <div class="grc-card" id="grc-card-37">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_37</div>
              <div>
                <div class="grc-title">Offboarding Population</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">From HiBob: filter employees who left during the audit period, across all sites. Evidence for offboarding and access revocation controls.</div>
          <div class="grc-tools"><span class="grc-tool-chip">HiBob</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-37"><span class="status-dot" id="dot-37"></span><span id="status-text-37">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('37','_37','Offboarding Population','From HiBob, list all employees who left (terminated/resigned) during the audit period across all sites. Include: name, last day, department, site. Confirm access revocation was completed for each.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-37"></div>
        </div>

        <div class="grc-card" id="grc-card-39">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_39</div>
              <div>
                <div class="grc-title">IT Access Review</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">IT team access review â€” verify that access rights are appropriate and have been reviewed during the audit period.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Okta</span><span class="grc-tool-chip">IT Systems</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-39"><span class="status-dot" id="dot-39"></span><span id="status-text-39">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('39','_39','IT Access Review','Collect evidence that an IT access review was conducted during the audit period. List systems reviewed, reviewer names, date of review, and actions taken (revocations, modifications). Flag any overdue reviews.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-39"></div>
        </div>

        <div class="grc-card" id="grc-card-41">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_41</div>
              <div>
                <div class="grc-title">Prod Security Groups</div>
                <div class="grc-category">Logical and Physical Access Controls</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Sample of production instances â€” review security group configurations. Verifies that network access is restricted per least-privilege principle.</div>
          <div class="grc-tools"><span class="grc-tool-chip">AWS Security Groups</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-41"><span class="status-dot" id="dot-41"></span><span id="status-text-41">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('41','_41','Prod Security Groups','Review security group configurations for a sample of production AWS instances. For each: list inbound/outbound rules, flag any 0.0.0.0/0 open rules, and confirm rules follow least-privilege. Recommend remediation for findings.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-41"></div>
        </div>

        <!-- â”€â”€ CHANGE MANAGEMENT â”€â”€ -->
        <div class="grc-card" id="grc-card-46">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_46</div>
              <div>
                <div class="grc-title">AWS Account Inventory</div>
                <div class="grc-category">Change Management</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Export all AWS accounts with their account IDs: production, staging, test. Confirms environment segregation is in place.</div>
          <div class="grc-tools"><span class="grc-tool-chip">AWS Organizations</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-46"><span class="status-dot" id="dot-46"></span><span id="status-text-46">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('46','_46','AWS Account Inventory','List all AWS accounts in the organization with their account ID, name, and environment type (prod/stag/test). Confirm environment separation is enforced. Flag any accounts without a clear owner or classification.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-46"></div>
        </div>

        <div class="grc-card" id="grc-card-51">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_51</div>
              <div>
                <div class="grc-title">Branch Protection Rules</div>
                <div class="grc-category">Change Management</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Print branch protection rules for master/main on the two in-scope GitHub repositories. Ensures code-review requirements are enforced before any merge.</div>
          <div class="grc-tools"><span class="grc-tool-chip">GitHub</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-51"><span class="status-dot" id="dot-51"></span><span id="status-text-51">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('51','_51','Branch Protection Rules','For the two in-scope GitHub repositories, report branch protection settings on master/main: required reviewers count, status checks required, admin bypass allowed, force push disabled. Flag any gaps.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-51"></div>
        </div>

        <div class="grc-card" id="grc-card-53">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_53</div>
              <div>
                <div class="grc-title">IaC Repo Access</div>
                <div class="grc-category">Change Management</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">List who has write/admin access to the Infrastructure-as-Code repository. Ensures only authorized personnel can modify production infrastructure definitions.</div>
          <div class="grc-tools"><span class="grc-tool-chip">GitHub</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-53"><span class="status-dot" id="dot-53"></span><span id="status-text-53">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('53','_53','IaC Repo Access','List all users and teams with write or admin access to the IaC GitHub repository. Flag any unexpected or over-privileged accounts. Confirm access matches the approved list.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-53"></div>
        </div>

        <div class="grc-card" id="grc-card-525354">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">52_53_54</div>
              <div>
                <div class="grc-title">Change Platform Data</div>
                <div class="grc-category">Change Management</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Platform-level change management data extraction â€” using the automated script from the previous audit. Covers all required change management evidence in one pull.</div>
          <div class="grc-tools"><span class="grc-tool-chip">GitHub</span><span class="grc-tool-chip">Terraform</span><span class="grc-tool-chip">CI/CD</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-525354"><span class="status-dot" id="dot-525354"></span><span id="status-text-525354">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('525354','52_53_54','Change Platform Data','Extract change management evidence for controls 52-54. Report: total deployments in audit period, deployments with approval, any that bypassed review, rollbacks performed. Confirm CI/CD pipeline enforces approval gates.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-525354"></div>
        </div>

        <!-- â”€â”€ RISK MITIGATION â”€â”€ -->
        <div class="grc-card" id="grc-card-55">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_55</div>
              <div>
                <div class="grc-title">Vendor Population</div>
                <div class="grc-category">Risk Mitigation</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">Extract the vendor population from the vendor registry (ZIP), filtered by the audit period. Confirms vendor risk management program coverage.</div>
          <div class="grc-tools"><span class="grc-tool-chip">Vendor Registry</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-55"><span class="status-dot" id="dot-55"></span><span id="status-text-55">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('55','_55','Vendor Population','From the vendor registry, list all active vendors in the audit period. For each: vendor name, contract dates, criticality tier, last security review date, and whether a current SOC2 or equivalent report is on file. Flag vendors with expired or missing reports.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-55"></div>
        </div>

        <!-- â”€â”€ AVAILABILITY â”€â”€ -->
        <div class="grc-card" id="grc-card-avail">
          <div class="grc-card-top">
            <div class="grc-left">
              <div class="grc-id">_57 Â· _58 Â· _59 Â· _60</div>
              <div>
                <div class="grc-title">Availability & DB Resilience</div>
                <div class="grc-category">Availability</div>
              </div>
            </div>
            <span class="grc-badge badge-full">âš¡ Yes</span>
          </div>
          <div class="grc-desc">DB backup status and retention (_57), Multi-AZ enabled on prod databases (_58), general availability check (_59), and dashboard + alert configuration (_60).</div>
          <div class="grc-tools"><span class="grc-tool-chip">AWS RDS</span><span class="grc-tool-chip">CloudWatch</span><span class="grc-tool-chip">Coralogix</span></div>
          <div class="grc-footer">
            <div class="grc-status" id="status-avail"><span class="status-dot" id="dot-avail"></span><span id="status-text-avail">Not run</span></div>
            <button class="btn-primary" onclick="runGRC('avail','_57+_58+_59+_60','Availability & DB Resilience','Check all four availability controls: (1) _57: confirm DB backups enabled with correct retention for prod databases; (2) _58: confirm Multi-AZ enabled for all prod RDS instances; (3) _59: check general availability posture; (4) _60: list active CloudWatch/Coralogix dashboards and alert configurations.')">â–¶ Run Agent</button>
          </div>
          <div class="grc-result" id="result-avail"></div>
        </div>

      </div><!-- /grc-grid -->
    </div><!-- /tab-grc -->

  </div><!-- /wrap -->

<script>
  const TOOL_ICONS = {
    navigate: "ğŸŒ", click: "ğŸ–±ï¸", fill: "âœï¸",
    get_page_content: "ğŸ“„", screenshot: "ğŸ“¸", press_key: "âŒ¨ï¸",
    fill_excel_cell: "ğŸ“", get_excel_structure: "ğŸ”",
  };

  let selectedFile = null;
  let smartQFile   = null;
  let smartCFile   = null;

  function switchTab(tab) {
    const names = ["browser", "excel", "smart", "kb", "grc"];
    document.querySelectorAll(".tab").forEach((t, i) => {
      t.classList.toggle("active", names[i] === tab);
    });
    names.forEach(n => {
      document.getElementById("tab-" + n).classList.toggle("active", n === tab);
    });
    if (tab === "kb") loadKBFiles();
  }

  async function runGRC(id, controlId, title, task) {
    const dot        = document.getElementById('dot-' + id);
    const statusText = document.getElementById('status-text-' + id);
    const resultDiv  = document.getElementById('result-' + id);
    const btn        = document.querySelector('#grc-card-' + id + ' button');

    dot.className = 'status-dot running';
    statusText.textContent = 'Runningâ€¦';
    resultDiv.textContent = '';
    resultDiv.classList.remove('visible');
    if (btn) { btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Runningâ€¦'; }

    // Policy Documents card (_6_21) uses its own dedicated route
    const endpoint = (id === '621') ? '/grc-policy' : '/grc-agent';

    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, controlId, title, task })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error');

      dot.className = 'status-dot done';
      statusText.textContent = 'Done â€” ' + new Date().toLocaleTimeString();

      // Build result text
      resultDiv.textContent = data.result;

      // If files with links are returned (Policy Documents), append a clickable file list
      if (data.files && data.files.length > 0) {
        const divider = document.createElement('hr');
        divider.style.cssText = 'margin:14px 0;border:none;border-top:1px solid var(--border)';
        const filesHeader = document.createElement('div');
        filesHeader.style.cssText = 'font-size:.78rem;font-weight:700;color:var(--text3);margin-bottom:8px;letter-spacing:.04em';
        filesHeader.textContent = 'ğŸ“‚ FILES IN FOLDER (' + data.files.length + ')';
        const filesList = document.createElement('div');
        filesList.style.cssText = 'display:flex;flex-direction:column;gap:5px';
        data.files.forEach(f => {
          const row = document.createElement('a');
          row.href = f.link;
          row.target = '_blank';
          row.rel = 'noopener noreferrer';
          row.style.cssText = 'font-size:.8rem;color:var(--accent2);text-decoration:none;display:flex;align-items:center;gap:6px';
          const icon = f.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';
          const date = f.modified ? ' Â· ' + f.modified : '';
          row.innerHTML = icon + ' ' + f.name + '<span style="color:var(--text3);font-size:.75rem">' + date + '</span>';
          row.onmouseover = () => row.style.textDecoration = 'underline';
          row.onmouseout  = () => row.style.textDecoration = 'none';
          filesList.appendChild(row);
        });
        resultDiv.appendChild(divider);
        resultDiv.appendChild(filesHeader);
        resultDiv.appendChild(filesList);
      }

      resultDiv.classList.add('visible');
    } catch (err) {
      dot.className = 'status-dot error';
      statusText.textContent = 'Error';
      resultDiv.textContent = 'âŒ ' + err.message;
      resultDiv.classList.add('visible');
    } finally {
      if (btn) { btn.disabled = false; btn.innerHTML = 'â–¶ Run Agent'; }
    }
  }

  function handleFileSelect(e) { setFile(e.target.files[0]); }
  function handleDragOver(e) { e.preventDefault(); document.getElementById("dropZone").classList.add("dragover"); }
  function handleDragLeave(e) { document.getElementById("dropZone").classList.remove("dragover"); }
  function handleDrop(e) {
    e.preventDefault(); document.getElementById("dropZone").classList.remove("dragover");
    const f = e.dataTransfer.files[0];
    if (f && f.name.match(/\.xlsx?$/i)) setFile(f);
  }
  function setFile(file) {
    selectedFile = file;
    document.getElementById("fileName").innerHTML =
      `<span class="file-badge">âœ… ${file.name} Â· ${(file.size/1024).toFixed(1)} KB</span>`;
  }

  function handleSmartFile(e, type) {
    const f = e.target.files[0]; if (!f) return;
    if (type === 'q') { smartQFile = f; document.getElementById("smartQName").innerHTML = `<span class="file-badge">âœ… ${f.name}</span>`; }
    else              { smartCFile = f; document.getElementById("smartCName").innerHTML = `<span class="file-badge">âœ… ${f.name}</span>`; }
  }
  function handleDragOver2(e)  { e.preventDefault(); e.currentTarget.classList.add("dragover"); }
  function handleDragLeave2(e) { e.currentTarget.classList.remove("dragover"); }
  function handleDrop2(e, type) {
    e.preventDefault(); e.currentTarget.classList.remove("dragover");
    const f = e.dataTransfer.files[0];
    if (f && f.name.match(/\.xlsx?$/i)) {
      if (type === 'q') { smartQFile = f; document.getElementById("smartQName").innerHTML = `<span class="file-badge">âœ… ${f.name}</span>`; }
      else              { smartCFile = f; document.getElementById("smartCName").innerHTML = `<span class="file-badge">âœ… ${f.name}</span>`; }
    }
  }

  async function runSmartFill() {
    if (!smartQFile) { alert("Please upload the questionnaire file"); return; }
    if (!smartCFile) { alert("Please upload the company profile file"); return; }
    document.getElementById("smartDownloadCard").style.display = "none";
    const btn = document.getElementById("smartBtn");
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Fillingâ€¦';
    showProgress("smartProgressWrap", "smartProgressBar");
    setStatus("smartStatus", "â³ Reading company profile and questionnaireâ€¦");
    try {
      const fd = new FormData();
      fd.append("questionnaire", smartQFile);
      fd.append("company_data", smartCFile);
      const res = await fetch("/smart-fill", { method: "POST", body: fd });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error || "Error"); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      document.getElementById("smartDownloadLink").href = url;
      document.getElementById("smartDownloadLink").download = smartQFile.name.replace(".xlsx","_filled.xlsx");
      finishProgress("smartProgressBar", "smartProgressWrap");
      document.getElementById("smartDownloadCard").style.display = "block";
      document.getElementById("smartResultText").textContent = "âœ… Questionnaire filled automatically based on company profile!";
      setStatus("smartStatus", "âœ… Done!");
    } catch (err) {
      setStatus("smartStatus", "âŒ " + err.message);
      document.getElementById("smartProgressWrap").style.display = "none";
    } finally {
      btn.disabled = false; btn.innerHTML = "ğŸ§  Auto-Fill";
    }
  }

  async function runAgent() {
    const task = document.getElementById("task").value.trim();
    if (!task) { alert("Please enter a task"); return; }
    document.getElementById("browserStepsCard").style.display = "none";
    document.getElementById("browserResultCard").style.display = "none";
    document.getElementById("browserSourcesCard").style.display = "none";
    document.getElementById("browserStepsList").innerHTML = "";
    document.getElementById("sourcesList").innerHTML = "";
    const btn = document.getElementById("runBtn");
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Runningâ€¦';
    setStatus("browserStatus", "â³ Agent is startingâ€¦");
    try {
      const res = await fetch("/agent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task }),
      });
      const data = await res.json();
      renderSteps(data.steps || [], "browserStepsList", "browserStepsCard");
      const fullText = data.result || data.error || "No result";
      renderResultWithSources(fullText);
      setStatus("browserStatus", "âœ… Done!");
    } catch (err) {
      setStatus("browserStatus", "âŒ " + err.message);
    } finally {
      btn.disabled = false; btn.innerHTML = "â–¶ Run Agent";
    }
  }

  function renderResultWithSources(text) {
    const parts = text.split('ğŸ“ Sources:');
    const answer = parts[0].trim();
    const sourcesRaw = parts[1] ? parts[1].trim() : null;

    document.getElementById("browserResultCard").style.display = "block";
    document.getElementById("resultText").textContent = answer;

    if (sourcesRaw) {
      const urls = sourcesRaw.split('\n')
        .map(l => l.replace(/^[-â€¢*]\s*/, '').trim())
        .filter(l => l.startsWith('http'));

      if (urls.length > 0) {
        const list = document.getElementById("sourcesList");
        list.innerHTML = urls.map(url => {
          const display = url.replace('https://', '').replace('http://', '');
          return `<a class="source-link" href="${url}" target="_blank" rel="noopener">
            <span class="source-icon">ğŸ“„</span>
            <span>${display}</span>
            <span style="margin-left:auto;font-size:11px;opacity:.5;">â†—</span>
          </a>`;
        }).join('');
        document.getElementById("browserSourcesCard").style.display = "block";
      }
    }
  }

  async function closeBrowser() {
    await fetch("/close", { method: "POST" });
    setStatus("browserStatus", "ğŸ”´ Browser closed");
  }

  async function fillExcel() {
    if (!selectedFile) { alert("Please select an Excel file"); return; }
    const info = document.getElementById("companyInfo").value.trim();
    if (!info) { alert("Please enter company details"); return; }
    document.getElementById("excelStepsCard").style.display = "none";
    document.getElementById("excelDownloadCard").style.display = "none";
    document.getElementById("excelStepsList").innerHTML = "";
    const btn = document.getElementById("excelBtn");
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Fillingâ€¦';
    showProgress("progressWrap", "progressBar");
    setStatus("excelStatus", "â³ Agent is reading the questionnaireâ€¦");
    try {
      const fd = new FormData();
      fd.append("file", selectedFile);
      fd.append("info", info);
      const res = await fetch("/fill-excel", { method: "POST", body: fd });
      if (!res.ok) { const err = await res.json(); throw new Error(err.error || "Unknown error"); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("downloadLink");
      link.href = url;
      link.download = selectedFile.name.replace(".xlsx","_filled.xlsx");
      finishProgress("progressBar", "progressWrap");
      document.getElementById("excelDownloadCard").style.display = "block";
      document.getElementById("excelResultText").textContent = "âœ… Questionnaire filled successfully! Click below to download.";
      setStatus("excelStatus", "âœ… Done!");
    } catch (err) {
      setStatus("excelStatus", "âŒ " + err.message);
      document.getElementById("progressWrap").style.display = "none";
    } finally {
      btn.disabled = false; btn.innerHTML = "ğŸ¤– Auto-Fill Questionnaire";
    }
  }

  function renderSteps(steps, listId, cardId) {
    if (!steps.length) return;
    document.getElementById(cardId).style.display = "block";
    steps.forEach((step, i) => {
      const icon = TOOL_ICONS[step.tool] || "ğŸ”§";
      const div = document.createElement("div");
      div.className = "step";
      div.innerHTML = `
        <div class="step-icon">${icon}</div>
        <div style="flex:1">
          <div class="step-tool">${i+1}. ${step.tool}</div>
          <div class="step-input">${JSON.stringify(step.input)}</div>
          <div class="step-result">${step.result}</div>
        </div>`;
      document.getElementById(listId).appendChild(div);
    });
  }

  function setStatus(id, msg) { document.getElementById(id).textContent = msg; }

  let progressIntervals = {};
  function showProgress(wrapId, barId) {
    const wrap = document.getElementById(wrapId);
    const bar  = document.getElementById(barId);
    wrap.style.display = "block"; bar.style.width = "0%";
    let p = 0;
    progressIntervals[barId] = setInterval(() => {
      p = Math.min(p + Math.random() * 3, 88);
      bar.style.width = p + "%";
    }, 800);
  }

  function finishProgress(barId, wrapId) {
    clearInterval(progressIntervals[barId]);
    const bar = document.getElementById(barId);
    bar.style.width = "100%";
    setTimeout(() => { document.getElementById(wrapId).style.display = "none"; }, 500);
  }

  function handleDragOverKB(e)  { e.preventDefault(); document.getElementById("dropZoneKB").classList.add("dragover"); }
  function handleDragLeaveKB(e) { document.getElementById("dropZoneKB").classList.remove("dragover"); }
  function handleDropKB(e) {
    e.preventDefault();
    document.getElementById("dropZoneKB").classList.remove("dragover");
    uploadKBFileList(e.dataTransfer.files);
  }

  async function uploadKBFiles(e) { uploadKBFileList(e.target.files); }

  async function uploadKBFileList(files) {
    if (!files.length) return;
    document.getElementById("kbUploadStatus").innerHTML = `<span class="file-badge">â³ Uploading ${files.length} file(s)â€¦</span>`;
    let uploaded = 0;
    for (const file of files) {
      const fd = new FormData(); fd.append("file", file);
      const res = await fetch("/upload-kb", { method: "POST", body: fd });
      if (res.ok) uploaded++;
    }
    document.getElementById("kbUploadStatus").innerHTML =
      `<span class="file-badge">âœ… ${uploaded} file(s) uploaded</span>`;
    loadKBFiles();
  }

  async function loadKBFiles() {
    const res  = await fetch("/list-kb");
    const data = await res.json();
    const list = document.getElementById("kbFilesList");
    if (!data.files.length) {
      list.innerHTML = '<span style="color:var(--text3)">No documents uploaded yet.</span>';
      return;
    }
    list.innerHTML = data.files.map(f => `
      <div class="kb-file-row">
        <span>ğŸ“„ ${f}</span>
        <button class="kb-delete-btn" onclick="deleteKBFile('${f}')">ğŸ—‘ Remove</button>
      </div>`).join("");
  }

  async function deleteKBFile(filename) {
    await fetch("/delete-kb", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ filename })
    });
    loadKBFiles();
  }

  async function askKB() {
    const question = document.getElementById("kbQuestion").value.trim();
    if (!question) { alert("Please enter a question"); return; }
    document.getElementById("kbAnswerCard").style.display = "none";
    const btn = document.getElementById("kbAskBtn");
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Searchingâ€¦';
    showProgress("kbProgressWrap", "kbProgressBar");
    setStatus("kbStatus", "â³ Searching through your documentsâ€¦");
    try {
      const res = await fetch("/ask-kb", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Error");
      finishProgress("kbProgressBar", "kbProgressWrap");
      document.getElementById("kbAnswerCard").style.display = "block";
      document.getElementById("kbAnswerText").textContent = data.answer;
      setStatus("kbStatus", "âœ… Done!");
    } catch (err) {
      setStatus("kbStatus", "âŒ " + err.message);
      document.getElementById("kbProgressWrap").style.display = "none";
    } finally {
      btn.disabled = false; btn.innerHTML = "ğŸ” Ask";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("task").addEventListener("keydown", e => {
      if (e.ctrlKey && e.key === "Enter") runAgent();
    });
    document.getElementById("kbQuestion").addEventListener("keydown", e => {
      if (e.ctrlKey && e.key === "Enter") askKB();
    });
    loadKBFiles();
  });
</script>
</body>
</html>
